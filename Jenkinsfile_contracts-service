def repoName  = 'git@gitlab.chisw.us:insk/contracts-service.git'
def repoCreds = 'ssh_gitlab'

timestamps {
    ansiColor('xterm') {
        node('nodes') {
            stage('Checkout Code') {
                checkout([
                    $class                           : 'GitSCM',
                    branches                         : [[name: "origin/${BRANCH_NAME}"]],
                    doGenerateSubmoduleConfigurations: false,
                    extensions                       : [[
                        $class: 'UserIdentity',
                        email : 'alexandr.kurilo@chisw.com',
                        name  : 'INSK Jenkins'
                    ]],
                    userRemoteConfigs: [[
                        credentialsId: repoCreds,
                        url          : repoName,
                        poll         : true
                    ]]
                ])
                short_commit = sh(
                    returnStdout: true,
                    script: 'git rev-parse --short HEAD'
                ).trim()
                currentBuild.displayName = "${currentBuild.id}_${BRANCH_NAME}-${short_commit}"
            }
            stage('Build image') {
                docker_image = docker.build("userssh_contracts-service_${short_commit}_${BRANCH_NAME}", '--no-cache -f /home/userssh/contracts-service/Dockerfile .')
            }
        }
    }
}